<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../neon-animation/animations/slide-right-animation.html">
<link rel="import" href="../neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../neon-animation/animations/slide-from-left-animation.html">
<link rel="import" href="datepicker-slide-from-right-animation.html">
<link rel="import" href="datepicker-slide-from-left-animation.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="jv-datepicker-theme.html">

<!--
An custom Polymer element created to provide a datepicker element that is more compelling and rich with features.

Example:

    <jv-datepicker><jv-datepicker>
    <jv-datepicker-dialog></jv-datepicker-dialog>
    <jv-datepicker-dialog modal></jv-datepicker-dialog>
    <jv-datepicker-dialog with-backdrop></jv-datepicker-dialog>

`jv-datepicker` provides a regular datepicker element.
While `jv-datepicker-dialog` has a `jv-datepicker` being wrapped inside a dialog.

### Event handling

`jv-datepicker` or `jv-datepicker-dialog` will fire an event `format-date` whenever a date is being selected via user interaction and it is one of the ways which user can make use of to retrieve the value of the selected date and bind it to your own property, say the `selectedDate` property in the example provided below.

Example:

    <jv-datepicker on-format-date="{{selectedDate}}"></jv-datepicker>

    <jv-datepicker-dialog modal on-format-date="{{selectedDate}}"></jv-datepicker-dialog>

### Generating your own boilerplate code of the element `jv-datepicker` or `jv-datepicker-dialog`

At the end of the demo, there is a section where user can play around with to generate your own boilerplate code with the attributes provided. Let's go and check out the demo!

### Styling

Style the datepicker with CSS as you would a normal DOM element.

    jv-datepicker-dialog#darkThemedDialog {
      background: #424242;
      --jv-datepicker-buttons: #80CBC4;
      --jv-datepicker-bg: #424242;
      --jv-datepicker-selection-bg: #555555;
      --jv-datepicker-selection-color: #cccccc;
      --jv-datepicker-iron-selected: #FFFFFF;
      --jv-datepicker-calendar-color: #ffffff;
      --jv-datepicker-calendar-bg: #424242;
      --jv-datepicker-weekdays-color: #c6c6c6;
      --jv-datepicker-selected-day-bg: #80CBC4;
      --jv-datepicker-selected-day-color: #555555;
      --jv-datepicker-selected-year-color: #80CBC4;
      --jv-datepicker-today-color: #80CBC4;
      --jv-datepicker-disabled-color: #ffff00;
      --jv-datepicker-icon-buttons-color: #ffff00;
      --jv-datepicker-icon-buttons-ink-color: #ffff00;
    }

By default, the datepicker is in light theme and now you are able to style almost all possible sections of the datepicker with your own choices of color.

The following custom properties and mixins are also available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--jv-datepicker-bg` | Background color of the datepicker | #fafafa
`--jv-datepicker-selection-bg` | Background color of the display section (selectionView) | #009688
`--jv-datepicker-selection-color` | Text color of the display section (selectionView) | #b2dfdb
`--jv-datepicker-iron-selected` | Text color of the view selector | #fefefe
`--jv-datepicker-calendar-bg` | Background color of calendar section | #fafafa
`--jv-datepicker-calendar-color` | Text color of calendar section | #000000
`--jv-datepicker-weekdays-color` | Text color of weekdays | #9b9b9b
`--jv-datepicker-selected-day-bg` | Background color of selected day | #009688
`--jv-datepicker-selected-day-color` | Text color of selected day | #ffffff
`--jv-datepicker-selected-year-color` | Text color of selected year in year list | #009688
`--jv-datepicker-today-color` | Text color of today's day | #009688
`--jv-datepicker-disabled-color` | Text color of disabled days | #9e9e9e
`--jv-datepicker-icon-buttons-color` | Text color of `paper-icon-button` | #737373
`--jv-datepicker-icon-button-ink-color` | Ink color of `paper-icon-button` | #737373
`--jv-datepicker` | Mixin applied to the datepicker | {}

@author motss
@element jv-datepicker, jv-datepicker-dialog
@demo demo/index.html
-->
<dom-module id="jv-datepicker">
  <template strip-whitespace>
    <style include="jv-datepicker-theme"></style>

    <!-- Element's code starts here -->
    <iron-media-query query="(orientation: portrait)" query-matches="{{_portrait}}"></iron-media-query>
    <div id="datepickerContainer" class$="{{_applyContentCls(_portrait)}}">
      <div id="selectionView" class="selection-view">
        <iron-selector selected="{{_selectedYearOrDate}}"
                       attr-for-selected="data-view"
                       class="iron-selector-selection-view">
          <div id="selectionViewYearSelected" class="year-selected selection-view-iron-selector" data-view="year">
            <span>{{_selectedYear}}</span>
          </div>
          <div id="selectionViewDateSelected" class="date-selected selection-view-iron-selector" data-view="date">
            <div class="selected-weekday">
              <span>{{_computeTextWeekday(_selectedWeekday, _slice)}}, </span>
            </div>
            <div class="selected-month-date">
              <span>{{_computeTextMonth(_selectedMonth, _slice)}} </span>
              <span>{{_selectedDate}}</span>
            </div>
          </div>
        </iron-selector>
      </div>

      <div class="calendar-view layout vertical flex-auto">
        <neon-animated-pages id="pages" class="pages flex-auto"
                                        selected="[[_selectedYearOrDatePage]]"
                                        entry-animation="fade-in-animation"
                                        exit-animation="fade-out-animation"
                                        attr-for-selected="data-page">
          <div class="calendar-page flex-auto layout vertical" data-page="date">
            <div id="monthYear" class="month-year-bar layout horizontal center-center">
              <paper-icon-button icon="chevron-left" on-tap="_prevMonth"></paper-icon-button>
              <div id="selectedMonthYear" class="selected-month-year flex-auto">{{_computeTextMonth(_activeMonth)}} {{_activeYear}}</div>
              <paper-icon-button icon="chevron-right" on-tap="_nextMonth"></paper-icon-button>
            </div>

            <div id="calendarView" data-view="calendar" class="full-calendar flex-auto layout vertical scroll">
              <div id="weekdays" class="weekdays-bar flex-auto layout horizontal center-center">
                <template is="dom-repeat" items="{{_weekdays}}">
                  <div class="weekday-column layout flex-auto center-center horizontal">
                    <span></span>
                    <span>{{item}}</span>
                    <span></span>
                  </div>
                </template>
              </div>

              <div class="calendar-without-weekdays-bar flex-auto scroll layout vertical">
                <div id="days" class="days-content flex-auto layout vertical">
                  <template is="dom-repeat" items="{{_calendar}}" as="day">
                    <div id$="[[_computeWeekId(index)]]" class="week-row layout horizontal center-center flex-auto">
                      <template is="dom-repeat" items="{{day}}">
                        <div class="day-column layout flex-auto center-center horizontal">
                          <span></span>
                          <div id$="[[_computeDayId(item)]]"
                               data-idx$="{{index}}"
                               class$="{{_computeDayStyle(item, index, _disableCls)}}"
                               disabled$="{{_computeDisabledAttr(index, _disableCls)}}"
                               on-tap="_selectDate">{{item}}</div>
                          <span></span>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <div data-page="year" class="year-page layout vertical">
            <div class="flex-auto scroll layout vertical year-selector">
              <iron-list id="yearList" class="flex year-list" items="{{_years}}" as="item" on-tap="_selectYear">
                <template>
                  <div class="layout horizontal center-center year-column">
                    <span data-year$="{{item.year}}" class$="{{_applyListCls(item.year, _refresh)}}">{{item.year}}</span>
                  </div>
                </template>
              </iron-list>
            </div>
          </div>
        </neon-animated-pages>
      </div>
    </div>
  </template>

</dom-module>

<script>

  var dateObject = new Date();

  Polymer({

    is: 'jv-datepicker',

    hostAttributes: {
      'role': 'datepicker'
    },

    properties: {
      // Animation Config for calendar.
      animationConfig: {
        value: function () {
          return {
            'incrementEntry': [
              {
                name: 'slide-from-right-animation',
                node: this.$.days
              },
              {
                name: 'slide-from-right-animation',
                node: this.$.weekdays
              },
              {
                name: 'datepicker-slide-from-right-animation',
                node: this.$.selectedMonthYear
              }
            ],
            'decrementEntry': [
              {
                name: 'slide-from-left-animation',
                node: this.$.days
              },
              {
                name: 'slide-from-left-animation',
                node: this.$.weekdays
              },
              {
                name: 'datepicker-slide-from-left-animation',
                node: this.$.selectedMonthYear
              }
            ],
            'incrementExit': {
              name: 'slide-left-animation',
              node: this.$.days
            },
            'decrementExit': {
              name: 'slide-right-animation',
              node: this.$.days
            }
          }
        }
      },
      /**
       * Public properties.
       */
      /**
       * Return selected date. Eg. '2020-02-20'.
       */
      bindDate: {
        type: String,
        value: function() {
          var _date, _yy, _mm, _dd;

          _date = dateObject;
          _dd = _date.getDate();
          _mm = _date.getMonth() + 1;
          _yy = _date.getFullYear();

          return Array.prototype.join.call([_yy, ('0' + _mm).slice(-2), _dd], '-');
        },
        computed: '_formatDate(dateFormat, _selectedYear, _selectedMonth, _selectedDate)',
        reflectToAttribute: true,
        notify: true
      },
      /**
       * Date format string. Default: 'yyyy-mm-dd'.
       */
      dateFormat: {
        type: String,
        value: function() {
          return 'yyyy-mm-dd';
        },
        reflectToAttribute: true
      },
      /**
       * Array of days numbered from 0 to 6 for disabling. Eg. weekends.
       * (`JSON.stringify` the array before passing in).
       */
      disableDays: {
        type: Array,
        value: function () {
          return JSON.stringify([]);
        },
        // reflectToAttribute: true,
        observer: '_disableDaysFunc'
      },
      /**
       * First Day of the week. Numbered days: 0 (Sun) to 6 (Sat).
       */
      firstDayOfWeek: {
        type: Number,
        value: 0,
        reflectToAttribute: true,
        observer: '_validateFirstDayOfWeek'
      },

      /*************************************************************************
       * Private Properties
       */
      // An object which consists of 100 years for selection.
      _years: {
        type: Object,
        value: function() {
          var t = [],
              _y = 2015;
          for (i= _y - 50 ; i <= _y + 50; i++) {
            t.push({
              year: i
            });
          }
          return t;
        }
      },
      // To indicate that list has been updated with list items.
      _listReady: {
        type: Boolean,
        value: false
      },
      // To indicate which page has been selected (year or date).
      _selectedYearOrDatePage: String,
      // Object of selected year from iron-list.
      _selectedYearIndex: {
        type: Object,
        value: function() {
          return (dateObject.getFullYear() - 2015) + 50 - 1;
        }
      },
      // To update the computed class. Used in iron-list.
      _refresh: {
        type: Boolean,
        value: false
      },
      // To update the computed clas. Used in disabled days in calendar.
      _disableCls: {
        type: Boolean,
        value: false,
        computed: '_updateCalendarCls(_shiftedDisableDays, _calendar, firstDayOfWeek)'
      },
      // Array contains rows of weeks which contains columns of days.
      _calendar: {
        type: Array,
        value: function() {
          return [];
        },
        computed: '_computeCalendar(_activeYear, _activeMonth, firstDayOfWeek)'
      },
      // Array contains disabled days shifted by different firstDayOfWeek.
      _shiftedDisableDays: {
        type: Array,
        value: function() {
          return [];
        },
        computed: '_shiftDisableDays(disableDays, firstDayOfWeek)'
      },
      // Array of all weekDays texts (S, M, T, W, T, F, S).
      _weekdays: {
        type: Array,
        value: function() {
          return [];
        },
        computed: '_computeWeekdays(firstDayOfWeek)'
      },
      // Selected weekday.
      _selectedWeekday: {
        type: String,
        value: function() {
          return dateObject.getDay();
        }
      },
      // Selected date.
      _selectedDate: {
        type: Number,
        value: function() {
          return dateObject.getDate();
        },
        observer: '_selectedDateChanged'
      },
      // Selected month.
      _selectedMonth: {
        type: String,
        value: function() {
          return dateObject.getMonth();
        }
      },
      // Selected year.
      _selectedYear: {
        type: Number,
        value: function (){
          return dateObject.getFullYear();
        }
      },
      // Currently active year.
      _activeYear: {
        type: Number,
        value: function() {
          return dateObject.getFullYear();
        }
      },
      // Currently active month.
      _activeMonth: {
        type: Number,
        value: function() {
          return dateObject.getMonth();
        },
        observer: '_activeMonthChanged'
      },
      // Currently active date.
      _activeDate: {
        type: Number,
        value: function() {
          return dateObject.getDate();
        }
      },
      // Used to update iron-list to propagate items.
      _selectedYearOrDate: {
        type: String,
        value: 'date'
      },
      // If true, slice first 3 letters of the month.
      _slice: {
        type: Boolean,
        value: true,
        readOnly: true
      },
      // If false, run animation.
      _animating: {
        type: Boolean,
        value: false
      }
    },
    // Element Lifecycle
    // ready: function () {}, attached: function () {},detached: function () {},

    // Element Behaviorset
    /**
     * The `format-date` event is fired whenever `_formatDate` is called.
     *
     * @event format-date
     * @detail {{date: String}}
     */
    behaviors: [
      Polymer.NeonAnimationRunnerBehavior
    ],
    listeners: {
      'neon-animation-finish': '_onNeonAnimationFinish'
    },
    observers: [
      '_fireIronResize(_selectedYearOrDate)',
      '_computeCalendar(_activeYear, _activeMonth, firstDayOfWeek)',
    ],

    /***************************************************************************
     * Applying classes.
     */

    // Calculate class based on screen orientation.
    _applyContentCls: function(_portrait) {
      var _cls = 'layout flex-auto content ';

      _cls += _portrait ? 'vertical' : 'horizontal';

      return _cls;
    },

    // Style selected date on calendar.
    _styleSelected: function (addCls) {
      if (addCls) {
        this.classList.add('day-selected');
      }else {
        if (this) {
          this.classList.remove('day-selected');
        }
      }
    },

    // Style day if it is today or being disabled.
    _computeDayStyle: function (_date, _dayIdx) {
      var _cls = 'day',
          _today = new Date(),
          _tm = _today.getMonth(),
          _ty = _today.getFullYear();
      if (_date === this._activeDate && this._activeMonth === _tm && this._activeYear === _ty) {
        _cls += ' is-today';
      }

      if (!_date || this._isDisabledDay(_dayIdx)) {
        _cls += ' is-disabled';
      }

      return _cls;
    },

    // Apply class to list.
    _applyListCls: function(_year) {
      var _cls = 'year-column-year ';
      if (_year === this._selectedYear) {
        _cls += ' selected-year';
      }
      return _cls;
    },

    /***************************************************************************
     * Rendering Datepicker.
     */

    // Compute weekdays based on _firstDayOfWeek.
    _computeWeekdays: function (_firstDayOfWeek) {
      var _arrayWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      for (var i = 0; i < _firstDayOfWeek; i++) {
        _arrayWeek.push(_arrayWeek.shift());
      }
      return _arrayWeek;
    },

    // Compute _calendar based on firstDayOfWeek.
    _computeCalendar: function (_activeYear, _activeMonth, _firstDayOfWeek) {
      // _activeMonth always changes.
      if (_activeMonth >= 0 && _activeMonth <= 11) {
        var _days = [],
            _weeks = [],
            _elem = '',
            _y = _activeYear,
            _m = _activeMonth,
            _firstDayOfMonth = (new Date(_y, _m, 1).getDay() + 7 - _firstDayOfWeek)%7,
            _totalDay = this._computeTotalDay(_firstDayOfMonth, _y, _m),
            _totalWeekRow = (_totalDay + _firstDayOfMonth) > 35 ? 42 : 35;
        for (var i = 1, j = 0; i <= _totalWeekRow; i++, j++) {
          if (_firstDayOfMonth < i) {
            _elem = (i - _firstDayOfMonth);
            _elem = _elem > _totalDay ? '' : _elem;
          }
          Array.prototype.push.call(_weeks, _elem);
          if (j >= 6) {
            Array.prototype.push.call(_days, _weeks);
            j = -1;
            _weeks = [];
          }
        }
        return _days;
      }
    },

    // Compute id for weekRow for styling.
    _computeWeekId: function (_idx) {
      if (_idx) {
        return 'week' + _idx;
      }
    },

    // Compute id for day.
    _computeDayId: function (_idx) {
      if (_idx) {
        return 'day' + _idx;
      }
    },

    // Compute Weekday based on index.
    _computeTextWeekday: function(_weekdayIdx, _slice) {
      var _selectWd = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][_weekdayIdx];
      if (_slice) {
        _selectWd = String.prototype.slice.call(_selectWd, 0, 3);
      }
      return _selectWd;
    },

    // Compute month to generate trimmed text of month.
    _computeTextMonth: function(monthIdx, _slice) {
      var _selectedMth = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIdx];
      if (_slice) {
        _selectedMth = String.prototype.slice.call(_selectedMth, 0, 3);
      }
      return _selectedMth;
    },

    // Compute total days in a month.
    _computeTotalDay: function (_firstDayOfMonth, _firstYear, _firstMonth) {
      if (_firstMonth >= 0 && _firstDayOfMonth <= 11) {
        var _totalDay = 31;
        switch (_firstMonth) {
          case 1:
            _totalDay = new Date(_firstYear, 1, 29).getMonth() === 1 ? 29 : 28;
            break;
          case 3:
          case 5:
          case 8:
          case 10:
            _totalDay = 30;
            break;
          case 0:
          case 2:
          case 4:
          case 6:
          case 7:
          case 9:
          case 11:
            break;
          default:
            console.log('Error at _computeTotalDay: Invalid _firstMonth ' + _firstMonth + '.');
        }
        return _totalDay;
      }
    },

    // Compute attr for disabled day.
    _computeDisabledAttr: function (_dayIdx) {
      return this._isDisabledDay(_dayIdx);
    },

    // Shift disable days if _firstDayOfWeek is not 0.
    _shiftDisableDays: function(_disableDays, _firstDayOfWeek) {
      // only shift _disableDays when _firstDayOfWeek > 0.
      var _disables = JSON.parse(_disableDays);
      if (_firstDayOfWeek > 0) {
        if (this._validateDisableDays(_disables)){
          return _disables.map(function(el) {
            return (el + 7 - _firstDayOfWeek)%7;
          });
        }
      }else {
        // return untouched _disableDays.
        return _disables;
      }
    },

    /***************************************************************************
     * Validations
     */

    // Check if valid firstDayOfWeek.
    _validateFirstDayOfWeek: function (oldVal, newVal) {
      if (typeof newVal !== 'undefined') {
        if (newVal < 0 || newVal > 6) {
          this.set('firstDayOfWeek', 0);
        }
      }
    },

    // Check if valid disableDays
    _validateDisableDays: function(_disableDays) {
      if (Array.isArray(_disableDays)) {
        return _disableDays.every(function(el){
          return el >= 0 && el < 7;
        });
      }
    },

    // Check if given date is disabled.
    _isDisabledDay: function (_date) {
      if (this._shiftedDisableDays) {
        return this._shiftedDisableDays.some(function (el) {
          return _date === el;
        });
      }
    },

    // Store _oldDate and style selected date.
    _selectedDateChanged: function (newValue, oldValue) {
    //   this._selectedDate = newValue;
      if (oldValue) {
        this._styleSelected.call(this.$.days.querySelector('#day' + oldValue));
      }
    },

    /***************************************************************************
     *  Runtime
     */
    // Do things when select a date on calendar.
    _selectDate: function (ev) {
      var target = ev.target;
      if (!target.hasAttribute('disabled') && ev.target.textContent) {
        this._selectedMonth = this._activeMonth;
        this._selectedDate = parseInt(ev.target.textContent);
        this._selectedYear = this._activeYear;
        this._selectedWeekday = new Date(this._activeYear, this._activeMonth, this._selectedDate).getDay();
        this._styleSelected.call(ev.target, true);
        // update select date.
        // this._formatDate(this.dateFormat, this._selectYear, this._selectedMonth, this._selectedDate);
      }
    },

    // one month back.
    _prevMonth: function () {
      if (!this._animating) {
        this.set('_animating', true);
        this.cancelAnimation();
        this.playAnimation('decrementExit');
        this._activeMonth--;
        this.cancelAnimation();
        this.playAnimation('decrementEntry');
      }
    },

    // one month forward.
    _nextMonth: function () {
      if(!this._animating) {
        this.set('_animating', true);
        this.cancelAnimation();
        this.playAnimation('incrementExit');
        this._activeMonth++;
        this.cancelAnimation();
        this.playAnimation('incrementEntry');
      }
    },

    // Change _activeYear based on transition of value change of _activeMonth.
    _activeMonthChanged: function (newValue, oldValue) {
      if (newValue < 0) {
        this.set('_activeMonth', 11);
        this._activeYear--;
      }else if (newValue > 11) {
        this.set('_activeMonth', 0);
        this._activeYear++;
      }
    },

    // Return formatted date string.
    _formatDate: function(_dateFormat, _selectedYear, _selectedMonth, _selectedDate) {
        var dateformat = _dateFormat,
            yearreg = dateformat.match(/y/gi),
            dayreg = dateformat.match(/d/gi),
            monthreg = dateformat.match(/m/gi);

        // regexp year
        if (yearreg) {
          var _formattedYear = _selectedYear;
          switch (yearreg.length) {
            case 2:
              if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]yy[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/^yy[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/[$-/:-?{-~!"^_`\[\]]yy$/)) {
                dateformat = dateformat.replace(/y{1,2}/gi, _formattedYear%100);
                break;
              }
            default:
              dateformat = dateformat.replace(/[o]*[y]+[y|o]*/gi, _formattedYear);
          }
        }

        // regexp day
        if (dayreg) {
          var _formattedDay = _selectedDate;
          switch (dayreg.length) {
            case 1:
              if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]d[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/^d[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/[$-/:-?{-~!"^_`\[\]]d$/)) {
                dateformat = dateformat.replace(/d/gi, _formattedDay);
                break;
              }

              if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]do[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/^do[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/[$-/:-?{-~!"^_`\[\]]do$/)) {
                var _suffixOrdinal, _cardinalNumber = _formattedDay%10;
                if (_formattedDay === 11 || _formattedDay === 12 || _formattedDay === 13) {
                  _suffixOrdinal = 'th';
                }else {
                  switch (_cardinalNumber) {
                    case 1:
                      _suffixOrdinal = 'st';
                      break;
                    case 2:
                      _suffixOrdinal = 'nd';
                      break;
                    case 3:
                      _suffixOrdinal = 'rd';
                      break;
                    default:
                      _suffixOrdinal = 'th';
                  }
                }
                dateformat = dateformat.replace(/[o]*[d]+[o]+/gi, _formattedDay + _suffixOrdinal);
                break;
              }
            case 2:
              if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]dd[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/^dd[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/[$-/:-?{-~!"^_`\[\]]dd$/)) {
                  dateformat = dateformat.replace(/[d]+/gi, _formattedDay.toString().replace(/^(\d)$/gi, '0$1'));
                break;
              }
            default:
              dateformat = dateformat.replace(/[o]*[d]+[d|0]*/gi, _formattedDay.toString().replace(/^(\d)$/gi, '0$1'));
          }
        }

        // regexp month
        if (monthreg) {
          // var _numberedMonth = this._activeMonth,
          var _numberedMonth = _selectedMonth,
              _formattedMonth;
          switch (monthreg.length) {
            case 1:
              if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]m[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/^m[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/[$-/:-?{-~!"^_`\[\]]m$/)) {
                dateformat = dateformat.replace(/m/gi, _numberedMonth + 1);
                break;
              }
            case 2:
            case 3:
            case 4:
              if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]m{2,4}[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/^m{2,4}[$-/:-?{-~!"^_`\[\]]/) ||
                  dateformat.match(/[$-/:-?{-~!"^_`\[\]]m{2,4}$/)) {
                _formattedMonth = _numberedMonth + 1;
                if (monthreg.length === 2) {
                  dateformat = dateformat.replace(/[m]+/gi, _formattedMonth.toString().replace(/^(\d)$/gi, '0$1'));
                }else if (monthreg.length === 3) {
                  dateformat = dateformat.replace(/[m]+/gi, this._selectedMonth);
                }else {
                  dateformat = dateformat.replace(/[m]+/gi, this._computeTextMonth(_numberedMonth));
                }
                break;
              }
            default:
              dateformat = dateformat.replace(/[o]*[m]+[o]*/gi, _numberedMonth + 1);
          }
        }
      return dateformat;
    },

    // Select year from yearList.
    _selectYear: function(ev) {
      var _target = ev.target,
          _selected;

      while (_target && _target.tagName !== 'SPAN') {
        _target = _target.parentElement;
      }

      if (_target) {
        if (_target.hasAttribute('data-year')) {
          var _selected = parseInt(_target.getAttribute('data-year')),
              _idx = (_selected - 2015) + 50;
          this._selectedYearIndex = _idx;
          this._selectedYear = _selected;
          this._activeYear = _selected;
          this._selectedYearOrDatePage = 'date';
          this._selectedYearOrDate = 'date';
          this._refresh = !this._refresh;
          // temporarily center year..
          this.$.yearList.scrollToIndex(_idx);
          this.$.yearList.scrollToIndex(_idx - 2);
        }
      }
    },

    // Fire iron-resize to update iron-list.
    _fireIronResize: function(_selectedYearOrDate) {
      if (!this._listReady && _selectedYearOrDate === 'year') {
        this.$.yearList.scrollToIndex(this._selectedYearIndex);
        this.$.yearList.fire('iron-resize');
        this.set('_listReady', true);
      }
      this._selectedYearOrDatePage = _selectedYearOrDate;
    },

    // Whenever _shiftDisableDays or _calendar changes in value,
    // update calendar class.
    _updateCalendarCls: function(_shiftedDisableDays, _calendar, _firstDayOfWeek) {
      return !this._disableCls;
    },
    // reflectToAttribute for Array.
    _disableDaysFunc: function(newVal, oldVal) {
      // might cause perf issue, leave it for debugging use.
      // might remove in the near future.
      this.setAttribute('disable-days', JSON.stringify(newVal));
    },
    // Force animation to run completely.
    _onNeonAnimationFinish: function () {
      this.set('_animating', false);
    },

//    _computeWeekNumber: function () {
//      var now = new Date(),
//          onejan = new Date(now.getFullYear(), 0, 1);
//          weekNumber = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
//      return weekNumber;
//    }
  });
</script>
