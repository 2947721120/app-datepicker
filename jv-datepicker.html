<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../neon-animation/neon-animations.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="jv-datepicker-theme.html">

<!--
An custom Polymer element created to provide a datepicker element that is more compelling and rich with features.

Example:

    <jv-datepicker><jv-datepicker>
    <jv-datepicker-dialog modal></jv-datepicker-dialog>
    <jv-datepicker-dialog with-backdrop></jv-datepicker-dialog>
    <jv-datepicker-dialog></jv-datepicker-dialog>

`jv-datepicker` provides a regular datepicker element.
While `jv-datepicker-dialog` has a `jv-datepicker` being wrapped inside a dialog.

### Event handling

`jv-datepicker` or `jv-datepicker-dialog` will fire an event `format-date` whenever a date is being selected via user interaction and it is one of the ways which user can make use of to retrieve the value of the selected date and bind it to your own property, say the `selectedDate` property in the example provided below.

Example:

    <jv-datepicker on-format-date="{{selectedDate}}"></jv-datepicker>

    <jv-datepicker-dialog modal on-format-date="{{selectedDate}}"></jv-datepicker-dialog>

### Generating your own boilerplate code of the element `jv-datepicker` or `jv-datepicker-dialog`

At the end of the demo, there is a section where user can play around with to generate your own boilerplate code with the attributes provided. Let's go and check out the demo!

### Styling

Style the datepicker with CSS as you would a normal DOM element.

    jv-datepicker {
      --jv-datepicker {
        color: var(--any-color-you-want);
      }
    }

    jv-datepicker-dialog#darkThemedDialog {
      --jv-datepicker-button-color: #80CBC4;
      --jv-datepicker-button-ink-color: #80CBC4;
      --jv-datepicker-icon-button-color: #ffff00;
      --jv-datepicker-icon-button-ink-color: #ffff00;
      --jv-datepicker-selected-day-bg: #80CBC4;
      --jv-datepicker-selected-day-color: #555555;
      --jv-datepicker-today-color: #80CBC4;
      --jv-datepicker-disabled-color: #ffff00;
      --jv-datepicker-selection-color: #ffffff;
      --jv-datepicker-selection-bg: #555555;
      --jv-datepicker-weekday-bg: #555555;
      --jv-datepicker-bg: #424242;
      --jv-datepicker-calendar-text-color: #ffffff;
      --jv-datepicker-calendar-bg: #424242;
      --jv-datepicker-selection-ripple-color: #ffff00;
      --jv-datepicker-weekdays-color: #c6c6c6;
    }

By default, the datepicker is in light theme and now you are able to style almost all possible sections of the datepicker with your own choices of color.

The following custom properties and mixins are also available for styling:

Custom property | Description | Default
----------------|-------------|----------
`--jv-datepicker-bg` | Background color of the datepicker | #ffffff
`--jv-datepicker-selection-bg` | Background color of the display section (selectionView) | #009688
`--jv-datepicker-selection-color` | Text color of the display section (selectionView) | #ffffff
`--jv-datepicker-weekday-bg` | Background color of the weekday in display section (selectionView) | #00796b
`--jv-datepicker-selection-ripple-color` | Ripple color in display section (selectionView) | Default color of `paper-ripple`
`--jv-datepicker-icon-button-color` | Color of `chevron-left` and `chevron-right` | #737373
`--jv-datepicker-icon-button-ink-color` | Ripple color of `chevron-left` and `chevron-right` | Default ripple color of `paper-icon-button`
`--jv-datepicker-calendar-bg` | Background color of calendar section | #fafafa
`--jv-datepicker-calendar-text-color` | Text color of calendar section | #000000
`--jv-datepicker-weekdays-color` | Text color of weekdays | #9b9b9b
`--jv-datepicker-today-color` | Text color of today's day | #009688
`--jv-datepicker-selected-day-bg` | Background color of selected day | #009688
`--jv-datepicker-selected-day-color` | Text color of selected day | #ffffff
`--jv-datepicker-disabled-color` | Text color of disabled days | #9e9e9e
`--jv-datepicker-button-color` | Text color of action buttons | #009688
`--jv-datepicker-button-ink-color` | Ripple color of action buttons | Default ripple color
`--jv-datepicker` | Mixin applied to the datepicker | {}

@author motss
@element jv-datepicker, jv-datepicker-dialog
@demo demo/index.html
-->
<dom-module id="jv-datepicker">
  <template>
    <style include="jv-datepicker-theme"></style>

    <!-- Element's code starts here -->
    <iron-media-query query="(orientation: portrait)" query-matches="{{_portrait}}"></iron-media-query>
    <!-- Datepicker Container-->
    <div id="datepickerContainer" class$="{{_computeContentCls(_portrait)}}">
      <!-- View Container -->
      <!-- <div id="viewContainer" class$="{{_computeContainerCls(portrait)}}"> -->
        <!-- Selection View-->
        <div id="selectionView" class="selection-view">
          <iron-selector selected="{{_selectedYearOrDate}}"
                         attr-for-selected="data-view"
                         class="iron-selector-selection-view">
            <div id="selectionViewYearSelected" class="year-selected selection-view-iron-selector" data-view="year">
              <span>{{_selectedYear}}</span>
            </div>
            <div id="selectionViewDateSelected" class="date-selected selection-view-iron-selector" data-view="date">
              <div class="selected-weekday">
                <span>{{_selectedWeekday}}, </span>
              </div>
              <div class="selected-month-date">
                <span>{{_selectedMonth}} </span>
                <span>{{_selectedDate}}</span>
              </div>
            </div>
          </iron-selector>
        </div>

        <div class="calendar-view layout vertical flex-auto">
          <neon-animated-pages id="pages" class="pages flex-auto"
                                          selected="[[_selectedYearOrDatePage]]"
                                          entry-animation="fade-in-animation"
                                          exit-animation="fade-out-animation"
                                          attr-for-selected="data-page">
            <!-- <neon-animatable data-page="date" class="calendar-page flex-auto layout vertical"> -->
              <div class="calendar-page flex-auto layout vertical" data-page="date">
                <div id="monthYear" class="month-year-bar layout horizontal center-center">
                  <paper-icon-button icon="chevron-left" on-tap="_prevMonth"></paper-icon-button>
                  <span id="selectedMonthYear">
                    <span>{{_selectedMonthYear}}</span>
                  </span>
                  <paper-icon-button icon="chevron-right" on-tap="_nextMonth"></paper-icon-button>
                </div>

                <div id="calendarView" data-view="calendar" class="full-calendar flex-auto layout vertical scroll">
                  <div id="weekdays" class="weekdays-bar flex-auto layout horizontal center-center">
                    <template is="dom-repeat" items="{{_weekdays}}">
                      <div class="weekday-column layout flex-auto center-center horizontal">
                        <span></span>
                        <span>{{item}}</span>
                        <span></span>
                      </div>
                    </template>
                  </div>

                  <div class="calendar-without-weekdays-bar flex-auto scroll">
                    <div id="days" class="days-content flex-auto layout vertical">
                      <template is="dom-repeat" items="{{_days}}" as="day">
                        <div id$="[[_computeWeekId(index)]]" class="week-row layout horizontal center-center">
                          <template is="dom-repeat" items="{{day}}">
                            <div class="day-column layout flex-auto center-center horizontal">
                              <span></span>
                              <div id$="[[_computeDayId(item)]]"
                                   class$="{{_computeDayStyle(item, index, _disableCls)}}"
                                   disabled$="{{_computeDisabledAttr(index, _disableCls)}}"
                                   on-tap="_selectDate">{{item}}</div>
                              <span></span>
                            </div>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            <!-- </neon-animatable> -->

            <neon-animatable data-page="year" class="year-page layout vertical">
                <div class="flex-auto scroll layout vertical year-selector">
                  <iron-list id="yearList" class="flex year-list" items="{{_years}}" as="item" on-tap="_selectYear">
                    <template>
                      <div class="layout horizontal center-center year-column">
                        <span data-year$="{{item.year}}">{{item.year}}</span>
                      </div>
                    </template>
                  </iron-list>
                </div>
            </neon-animatable>
          </neon-animated-pages>
        </div>
      <!-- </div> -->
    </div>
  </template>

</dom-module>

<script>

  var newDate = new Date();

  Polymer({

    is: 'jv-datepicker',

    hostAttributes: {
      'role': 'datepicker'
    },

    properties: {
      startDay: {
        type: Number,
        value: 0
      },
      disableDays: {
        type: Array,
        value: function () {
          return [];
        }
      },
      _shiftedDisableDays: Array,
      _weekdays: {
        type: Array,
        value: function() {
          return [];
        }
      },
      _days: {
        type: Array,
        value: function() {
          return [];
        }
      },
      _selectedWeekday: {
        type: String,
        value: function() {
          return this._computeWeekday(newDate.getDay());
        }
      },
      _selectedDate: {
        type: Number,
        value: function() {
          return newDate.getDate();
        },
        observer: '_selectedDateChanged'
      },
      _selectedMonth: {
        type: String,
        value: function() {
          return this._computeMonth(newDate.getMonth(), true);
        }
      },
      _oldDate: Number,
      _todayDate: {
        type: Number,
        value: function() {
          return newDate.getDate();
        }
      },
      _todayMonth: {
        type: Number,
        value: function() {
          return newDate.getMonth();
        },
        observer: '_todayMonthChanged'
      },
      _selectedYear: {
        type: Number,
        value: function (){
          return newDate.getFullYear();
        }
      },
      _todayYear: {
        type: Number,
        value: function() {
          return newDate.getFullYear();
        }
      },
      _selectedMonthYear: String,
      _mthOffset: {
        type: Number,
        value: 0,
        observer: '_computeMonthYear'
      },
      _selectedView: {
        type: String,
        value: 'calendar'
      },
      _tempYear: Number,
      format: {
        type: String,
        value: function() {
          return 'yyyy-mm-dd';
        }
      },
      bindDate: {
        type: String,
        value: '2015-09-31',
        notify: true
      },
      _disableCls: {
        type: Boolean,
        value: false
      },
      resetDate: {
        type: Boolean,
        value: false
      },
      _selectedYearOrDate: {
        type: String,
        value: 'date'
      },
      _years: {
        type: Object,
        value: function() {
          var t = [],
              _y = 2015;

          for (i= _y - 50 ; i <= _y + 50; i++) {
            t.push({
              year: i
            })
          }

          return t;
        }
      },
      _listReady: {
        type: Boolean,
        value: false
      },
      _selectedYearOrDatePage: String,
      _selectedYearIndex: {
        type: Object,
        value: {}
      }
    },
    // Element Lifecycle
    // ready: function () {},attached: function () {},detached: function () {},

    // Element Behaviorset
    /**
     * The `format-date` event is fired whenever `_formatDate` is called.
     *
     * @event format-date
     * @detail {{date: String}}
     */

    observers: [
      '_propChanged(startDay, disableDays, format)',
      '_fireIronResize(_selectedYearOrDate)'
    ],

    // Calculate class based on screen orientation.
    _computeContentCls: function(_portrait) {
      var _cls = 'layout flex-auto content ';

      _cls += _portrait ? 'vertical' : 'horizontal';

      return _cls;
    },
    // _computeContainerCls: function (portrait) {
    //   var cls = 'layout vertical center-center';
    //   if (!portrait) {
    //     cls = 'layout horizontal center-center';
    //   }
    //   return cls;
    // },

    _computeWeekdays: function (startDay) {
      var arrayWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      if (this._validateStartDay(startDay)) {
        for (var i = 0; i < startDay; i++) {
          arrayWeek.push(arrayWeek.shift());
        }
      }
      return arrayWeek;
    },

    _computeDays: function () {
      var arrayDays = [],
          arrayWeeks = [],
          pushElem,
          firstYear = this._todayYear,
          firstMonth = this._todayMonth,
          startDay = !this._validateStartDay(this.startDay)? 0: this.startDay%7,
          firstDayOfMonth = (new Date(firstYear, firstMonth, 1).getDay() + 7 - startDay)%7,
          totalDay = this._computeTotalDay(firstDayOfMonth, firstYear, firstMonth),
          totalRow = (totalDay + firstDayOfMonth)>35? 42: 35;
      for (var i = 1, j = 0; i <= totalRow; i++, j++) {
        pushElem = i;

        if (firstDayOfMonth >= i) {
          pushElem = '';
        }else {
          pushElem = (pushElem - firstDayOfMonth) > totalDay? '': pushElem - firstDayOfMonth;
        }
        arrayWeeks.push(pushElem);
        if (j >= 6) {
          arrayDays.push(arrayWeeks);
          j = -1;
          arrayWeeks = [];
        }
      }
      this._days = arrayDays;
    },

    _computeWeekId: function (idx) {
      return 'week' + idx;
    },

    _selectedDateChanged: function (newValue, oldValue) {
      this._oldDate = oldValue;
      this._selectedDate = newValue;
      if (oldValue) {
        this._styleSelected.bind(this.$.days.querySelector('#day' + oldValue))();
      }
    },

    _selectDate: function (ev) {
      var target = ev.target;
      if (!target.hasAttribute('disabled') && ev.target.textContent) {
        this._selectedMonth = this._computeMonth(this._todayMonth, true);
        this._selectedDate = parseInt(ev.target.textContent);
        this._selectedYear = this._todayYear;
        this._selectedWeekday = this._computeWeekday(new Date(this._todayYear, this._todayMonth, this._selectedDate).getDay());
        this._styleSelected.bind(ev.target, true)();
      }
    },

    _styleSelected: function (addCls) {
      if (addCls) {
        this.classList.add('day-selected');
      }else {
        if (this) {
          this.classList.remove('day-selected');
        }
      }
    },

    _computeDayStyle: function (date, whichDay) {
      var cls = 'day',
          today = new Date(),
          tm = today.getMonth(),
          ty = today.getFullYear();
      if (date === this._todayDate && this._todayMonth === tm && this._todayYear === ty) {
        cls = cls + ' is-today';
      }
      if (!date || this._isDisabledDay(whichDay)) {
        cls = cls + ' is-disabled';
      }
      return cls;
    },

    _computeDayId: function (idx) {
      return 'day' + idx;
    },

    _computeMonthYear: function () {
      var preTodayMth = this._todayMonth + this._mthOffset;
      this._todayMonth = (preTodayMth) < 0? 11: (preTodayMth)%12;
      this._mthOffset = 0;
      this._computeDays();
      this._selectedMonthYear = this._computeMonth(this._todayMonth) + ' ' + this._todayYear;
    },

    _computeMonth: function(monthIdx, to_slice) {
      var selectedMth = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIdx];
      if (to_slice) {
        selectedMth = selectedMth.slice(0, 3);
      }
      return selectedMth;
    },

    _computeWeekday: function(weekdayIdx) {
      return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][weekdayIdx];
    },

    _prevMonth: function () {
      this._mthOffset--;
    },

    _nextMonth: function () {
      this._mthOffset++;
    },

    _todayMonthChanged: function (newValue, oldValue) {
      if (oldValue === 0 && newValue === 11){
        this._todayYear--;
      }else if(oldValue === 11 && newValue === 0){
        this._todayYear++;
      }
    },

    _computeTotalDay: function (firstDayOfMonth, firstYear, firstMonth) {
      var totalDay = 31;
      if (firstMonth === 1) {
        totalDay = new Date(firstYear, 1, 29).getMonth() === 1? 29: 28;
      }

      if (firstMonth === 3 || firstMonth === 5 || firstMonth === 8 || firstMonth === 10) {
          totalDay = 30;
      }
      return totalDay;
    },

    _goYearView: function () {
      if (this._selectedView === 'year') {
        return;
      }else {
        this._tempYear = this._todayYear;
        this._selectedView = 'year';
      }
    },

    _goCalView: function () {
      if (this._selectedView === 'calendar') {
        return;
      }else {
        this._todayYear = this._tempYear || this._selectedYear;
        this._selectedView = 'calendar';
      }
    },

    _prevCentury: function () {
      this._todayYear = this._todayYear - 100;
    },

    _prevDecade: function () {
      this._todayYear = this._todayYear - 10;
    },

    _prevYear: function () {
      this._todayYear--;
    },

    _nextCentury: function () {
      this._todayYear = this._todayYear + 100;
    },

    _nextDecade: function () {
      this._todayYear = this._todayYear + 10;
    },

    _nextYear: function () {
      this._todayYear++;
    },

    _changeYear: function (ev) {
      this._selectedYear = this._todayYear;
      this._computeMonthYear();
      this._computeDays();
      this._selectedView = 'calendar';
    },

    _isDisabledDay: function (date) {
      if (this._shiftedDisableDays) {
        return this._shiftedDisableDays.some(function (el) {
          return date === el;
        });
      }
    },

    _validateDisableDays: function(disableDaysArr) {
      if (Array.isArray(disableDaysArr)) {
        return disableDaysArr.every(function(el){
          return el >= 0 && el < 7;
        });
      }
    },

    _validateStartDay: function(startDay) {
      return startDay >= 0 && startDay < 7;
    },

    _computeDisabledAttr: function (whichDay) {
      return this._isDisabledDay(whichDay);
    },

    _shiftDisabledDays: function(disableDaysArr, startDay) {
      if (this._validateDisableDays(disableDaysArr) && this._validateStartDay(startDay)){
        var temp = [];
        disableDaysArr.forEach(function(el) {
          temp.push((el + 7 - startDay)%7);
        });
        this._shiftedDisableDays = temp;
      }else {
        this.setAttribute('disable-days', 'invalidArr');
      }
    },

    _formatDate: function() {
      var dateformat = this.format;
      var yearreg = dateformat.match(/y/gi),
          dayreg = dateformat.match(/d/gi),
          monthreg = dateformat.match(/m/gi);

      // regexp year
      if (yearreg) {
        var _formattedYear = this._selectedYear;
        switch (yearreg.length) {
          case 2:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]yy[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^yy[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]yy$/)) {
              dateformat = dateformat.replace(/y{1,2}/gi, _formattedYear%100);
              break;
            }
          default:
            dateformat = dateformat.replace(/[o]*[y]+[y|o]*/gi, _formattedYear);
        }
      }

      // regexp day
      if (dayreg) {
        var _formattedDay = this._selectedDate;
        switch (dayreg.length) {
          case 1:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]d[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^d[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]d$/)) {
              dateformat = dateformat.replace(/d/gi, _formattedDay);
              break;
            }

            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]do[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^do[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]do$/)) {
              var _suffixOrdinal, _cardinalNumber = _formattedDay%10;
              if (_formattedDay === 11 || _formattedDay === 12 || _formattedDay === 13) {
                _suffixOrdinal = 'th';
              }else {
                switch (_cardinalNumber) {
                  case 1:
                    _suffixOrdinal = 'st';
                    break;
                  case 2:
                    _suffixOrdinal = 'nd';
                    break;
                  case 3:
                    _suffixOrdinal = 'rd';
                    break;
                  default:
                    _suffixOrdinal = 'th';
                }
              }
              dateformat = dateformat.replace(/[o]*[d]+[o]+/gi, _formattedDay + _suffixOrdinal);
              break;
            }
          case 2:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]dd[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^dd[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]dd$/)) {
                dateformat = dateformat.replace(/[d]+/gi, _formattedDay.toString().replace(/^(\d)$/gi, '0$1'));
              break;
            }
          default:
            dateformat = dateformat.replace(/[o]*[d]+[d|0]*/gi, _formattedDay.toString().replace(/^(\d)$/gi, '0$1'));
        }
      }

      // regexp month
      if (monthreg) {
        var _numberedMonth = this._todayMonth, _formattedMonth;
        switch (monthreg.length) {
          case 1:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]m[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^m[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]m$/)) {
              dateformat = dateformat.replace(/m/gi, _numberedMonth + 1);
              break;
            }
          case 2:
          case 3:
          case 4:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]m{2,4}[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^m{2,4}[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]m{2,4}$/)) {
              _formattedMonth = _numberedMonth + 1;
              if (monthreg.length === 2) {
                dateformat = dateformat.replace(/[m]+/gi, _formattedMonth.toString().replace(/^(\d)$/gi, '0$1'));
              }else if (monthreg.length === 3) {
                dateformat = dateformat.replace(/[m]+/gi, this._selectedMonth);
              }else {
                dateformat = dateformat.replace(/[m]+/gi, this._computeMonth(_numberedMonth));
              }
              break;
            }
          default:
            dateformat = dateformat.replace(/[o]*[m]+[o]*/gi, _numberedMonth + 1);
        }
      }
      // bind and fire formatted date
      this.bindDate = dateformat;
      this.fire('format-date', {date: dateformat});
      if (this.resetDate) {
        this._resetDate();
      }
    },

    _propChanged: function(startDay, disableDays, format) {
      this._weekdays = this._computeWeekdays(startDay);
      this._shiftDisabledDays(disableDays, startDay);
      this._computeDays();
      this._disableCls = !this._disableCls;
    },

    _resetDate: function() {
      this._todayYear = new Date().getFullYear();
      this._todayMonth = new Date().getMonth();
      this._computeMonthYear();
    },

    _selectYear: function(ev) {
      var _target = ev.target,
          _selected;

      while (_target && _target.tagName !== 'SPAN') {
        _target = _target.parentElement;
      }

      if (_target) {
        if (_target.hasAttribute('data-year')) {
          _selected = parseInt(_target.getAttribute('data-year'));
          this._selectedYearIndex.index = (_selected - 2015) + 50;
          this._selectedYearIndex.year = _selected;
          this._selectedYearOrDatePage = 'date';
          this._selectedYearOrDate = 'date';
          console.log(_selected);
        }
      }
    },

    _fireIronResize: function(_selectedYearOrDate) {
      if (!this._listReady && _selectedYearOrDate === 'year') {
        this.$.yearList.scrollToIndex(50);
        this.$.yearList.fire('iron-resize');
        this.set('_listReady', true);
      }
      this._selectedYearOrDatePage = _selectedYearOrDate;
    },

//    _computeWeekNumber: function () {
//      var now = new Date(),
//          onejan = new Date(now.getFullYear(), 0, 1);
//          weekNumber = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
//      return weekNumber;
//    }
  });
</script>
