<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">

<!--
An custom Polymer element created to provide a datepicker element that is more compelling and rich with features.

Example:

    <jv-datepicker><jv-datepicker>
    <jv-datepicker-dialog modal></jv-datepicker-dialog>

`jv-datepicker` provides a regular datepicker element.
While `jv-datepicker-dialog` has a `jv-datepicker` being wrapped inside a dialog.

### Event handling

`paper-swipe` will fire an event `format-date` whenever a date is being selected via user interaction and it is one of the ways which user can make use of to retrieve the value of the selected date and bind it to your own property, say the `selectedDate` property in the example provided below.

Example:

    <jv-datepicker on-format-date="{{selectedDate}}"></jv-datepicker>

    <jv-datepicker-dialog modal on-format-date="{{selectedDate}}"></jv-datepicker-dialog>

### Generating your own boilerplate code of the element `jv-datepicker` or `jv-datepicker-dialog`

At the end of the demo, there is a section where user can play around with to generate your own boilerplate code with the attributes provided. Let's go and check out the demo!

@author motss
@element jv-datepicker, jv-datepicker-dialog
@demo demo/index.html
-->
<dom-module id="jv-datepicker">

  <style is="custom-style">
    :host {
      /* based on Galaxy Nexus which has a resolution of 360 by 460 at 2dppx */
      /* max-height = 640 - 64 = 576px */
      /* max-width = 320 - 32 = 288px */
      /* based on Troy's Galaxy Nexus, */
      /* combined height of all bars: 640 - 567 = 73px */
      /* iframe w/  addr-bar: 567px */
      /* iframe w/o addr-bar: 517px */
      /* max-viewport-height w/  addr-bar: 501px vs 485px*/
      /* max-viewport-height w/o addr-bar: 548px vs 532px */
      display: block;
      position: relative;
      height: 100%;
      width: 100%;
      /*min-height: 576px;*/
      /*min-width: 576px;*/
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
/**/
      @apply(--paper-font-common-base);
      @apply(--paper-font-common-expensive-kerning);
      /*@apply(--layout-vertical);
      @apply(--layout-center-center);*/

      /*margin: auto;*/
      /*padding-bottom: 8px;*/
      background: #ffffff;
    }

    :host, #datepickerContainer {
      /*max-height: calc(517px - 32px);*/
      max-height: calc(100vh - 32px);
      max-width: calc(100vw - 32px - 32px);
    }

    #datepickerContainer, #datepickerContainer div {
      /*width: calc(360px - 64px);*/
      width: calc(100vw - 64px);
      position: relative
    }

    /* to be removed soon */
    div {
      /*border: 1px solid;*/
    }

    /* layout-ing containers */
    #datepickerContainer, #selectionView {
      /*@apply(--layout-vertical);
      @apply(--layout-center-center);*/
    }

    #selectionView {
      /*background: var(--google-green-500);*/
      background: var(--paper-teal-500, #009688);
      color: #ffffff;
      text-align: center;
      /*min-height: 215px;*/
    }

    /* #weekdayContainer */
    #weekdayContainer {
      background: var(--paper-teal-700, #00796b);
      padding-bottom: 6px;
    }

    /* #dateContainer */
    #dateContainer {
      padding: 12px 0;
    }

    /* #month */
    #month {
      text-transform: uppercase;
      font-size: 27px;
    }

    /* #year */
    #year {
      font-size: 25px;
    }

    /* #day */
    #day {
      font-size: 90px;
    }

    /* #monthYear */
    #monthYear {
      padding: 3px 0;
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
    }

    /* #selectedMonthYear */
    #selectedMonthYear {
      text-align: center;
      @apply(--layout-flex-auto);
    }

    /* #weekdays */
    #weekdays {
      text-align: center;
      padding: 3px 0;
      @apply(--layout-horizontal);
    }

    /* #weekdays span */
    #weekdays span {
      @apply(--layout-flex-2);
    }

    /* #buttonContainer */
    #buttonContainer {
      /*top: -8px;*/
      @apply(--layout-horizontal);
      @apply(--layout-end-justified);
    }

    /* paper-button */
    paper-button {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      color: var(--paper-teal-500);
    }

    paper-button /deep/ .keyboard-focus {
      font-weight: normal;
    }

    /* week[n] */
    /*div[id^="week"] {*/
      /*@apply(--layout-horizontal);*/

    /*}*/

    /*div[id^="week"] span {*/
      /*text-align: center;*/
      /*@apply(--layout-flex-2);*/
    /*}*/

    /* .week-contaienr */
    .week-container {
      /*border: 1px solid red;*/
      padding: 3px 0;
      text-align: center;
      min-height: calc(22px + 6px);
      @apply(--layout-horizontal);
      @apply(--layout-center-center);
    }

    /* .day-container */
    .day-container {
      /*border: 1px solid blue;*/
      @apply(--layout);
      /*@apply(--layout-center-center);*/
      @apply(--layout-flex-2);
    }

    /* .day */
    .day {
      min-width: 22px;
      min-height: 22px;
      font-size: 12px;
      @apply(--layout);
      @apply(--layout-center-center);
    }

    /* .day-selected */
    div .day-selected {
      background: var(--paper-teal-500, #009688);
      color: #ffffff;
      border-radius: 50%;
      margin-left: auto;
      margin-right: auto;
      padding: 3px;
    }

    /* to style today */
    .is-today {
      color: var(--paper-teal-500, #009688);
    }

    /* to style disabled days */
    .is-disabled {
      color: var(--paper-grey-500, #9e9e9e);
    }

    neon-animated-pages {
      /*height: calc(100vh - 32px - 215px - 42px);*/
      height: calc(100vh - 32px - 215px - 50px);
      /*height: 275px;*/ /* neon-animated-pages has zero height, explicitly height is set.*/
    }

    #calendarView {
      overflow: hidden;
    }

    #days {
      /*max-height: calc(100vh - 32px - 215px - 42px - 46px - 25px);*/
      max-height: calc(100vh - 32px - 215px - 50px - 46px - 25px);
      /*padding: 0 16px 16px 0;*/
      padding-right: 16px;
      -webkit-overflow-scrolling: touch;
      overflow: auto;
    }

    /* #yearContainer */
    #yearContainer, #dayContainer {
      position: relative;
    }

    /* expand-family-group */
    #yearView {
      @apply(--layout-vertical);
      @apply(--layout-center-center);
    }

    #yearView #expandContainer * {
      width: initial;
    }

    #expandMoreGroup, #expandLessGroup, #expandYear {
      text-align: center;
      padding: 3px 0 3px 40px;
    }

    #expandYear {
      font-size: 70px;
      padding: 3px 0;
    }

    /* workaround for Mozilla Firefox */
    @-moz-document url-prefix(){
      span.day-container {
        /*max-width: calc(296px/ 7.3);*/
        max-width: calc((100vw - 64px - 280px)/ 7.3);
      }
    }

    /* Google Galaxy Nexus @ landscape */
    @media all and (orientation: landscape) {
      :host, #datepickerContainer {
        min-height: calc(100vh - 32px);
        min-width: calc(100vw - 64px);
        /*max-height: calc(100vh - 32px);
        max-width: calc(100vw - 32px - 32px);*/
      }

      #datepickerContainer, #datepickerContainer div {
        /*width: calc(360px - 64px);*/
      }

      #selectionView div{
        width: calc(100vw - 64px - 296px);
        /*max-width: calc(100vw - 64px - 296px);*/
        /*max-width: calc(640px - 64px - 296px);*/
      }

      /* layout-ing containers */
      #datepickerContainer, #selectionView {
        /*max-height: calc(100vh - 32px - 42px);*/
        max-height: calc(100vh - 32px - 50px);
      }

      #viewContainer, neon-animated-pages {
        /*height: calc(100vh - 32px - 42px);*/
        height: calc(100vh - 32px - 50px);
      }

      #dateContainer {
        /*height: calc(100vh - 32px - 42px - 25px);*/
        height: calc(100vh - 32px - 50px - 25px);
      }

      #days {
        /*max-height: calc(100vh - 32px - 42px - 46px - 25px);*/
        max-height: calc(100vh - 32px - 50px - 46px - 25px);
      }

      div #buttonContainer {
        width: calc(100vw - 64px);
      }
    }

    /* IP4, IP5 Portrait */
    /* IP4 status bar - 20px */
    /* IP4 nav-bar - 50px */
    /* IP4 viewport height - 410px */
    @media all and (min-width: 0) and (max-width: 359px) and (max-height: 480px) and (orientation: portrait) {
      :host, #datepickerContainer {
        /*max-height: calc(410px - 32px);*/
        /*max-height: calc(100vh - 32px);*/
      }

      #dateContainer {
        padding: 3px 0;
        @apply(--layout-horizontal);
      }

      neon-animated-pages {
        /*height: 200px;*/
        height: calc(100vh - 50px - 136px - 32px);
      }

      #days {
        /*max-height: calc(200px - 46px - 25px);*/
        max-height: calc(100vh - 136px - 46px - 25px - 50px - 32px);
      }
    }

    @media all and (max-width: 359px) and (min-height: 481px) and (max-height: 568px) and (orientation: portrait) {
      :host, #datepickerContainer {
        /*max-height: calc(498px - 32px);*/
      }

      #dateContainer {
        padding: 6px 0;
        @apply(--layout-vertical);
      }

      neon-animated-pages {
        /*height: calc(498px - 32px - 25px - 178px - 42px);*/
        height: calc(100vh - 32px - 203px - 50px);
      }

      #days {
        max-height: calc(100vh - 32px - 203px - 50px - 46px - 25px);
      }
    }

    /* min-width 640px mobile landscape */
    @media all and (min-width: 481px) and (max-width: 799px) and (orientation: landscape) {
       neon-animated-pages, neon-animated-pages #calendarView, #calendarView div, neon-animated-pages #yearView, #yearView div {
        width: 296px;
      }
    }

    /* IP4 and IP5 landscape */
    @media all and (min-width: 480px) and (max-width: 568px) and (orientation: landscape) {
      #selectionView, #selectionView div {
        max-width: calc(100vw - 64px - 296px);
        /*max-height: calc(100vh - 32px - 42px);*/
        max-height: calc(100vh - 32px - 50px);
      }

      neon-animated-pages div {
        max-width: 296px;
      }

      #selectionView #dateContainer {
        /*height: calc(100vh - 32px - 42px - 25px - 6px);*/
        /*height: calc(100vh - 32px - 50px - 25px - 6px);*/
      }

      #weekdayContainer {
        padding-bottom: 0;
      }

      #monthContainer, #yearContainer {
        height: 20px;
      }

      #monthContainer span, #yearContainer span {
        font-size: 20px;
      }

      #dayContainer {
        height: 93px;
      }

      #dayContainer span {
        font-size: 80px;
      }

      #dateContainer {
        padding: 6px 0;
      }
    }


    /* N7 2013 Portrait and 800px PC potrait */
    @media all and (min-width: 600px) and (min-height: 600px) and (orientation: portrait) {
      :host, #datepickerContainer {
        min-width: 320px;
        min-height: 480px;
        max-width: 360px;
        max-height: 640px;
      }

      #datepickerContainer, #datepickerContainer div {
        width: 360px;
      }

      #viewContainer {
        /*max-height: calc(640px - 42px);*/
        max-height: calc(640px - 50px);
        @apply(--layout-vertical);
      }

      neon-animated-pages {
        /*height: calc(640px - 42px - 215px);*/
        height: calc(640px - 50px - 215px);
      }
    }

    /* N7 2013 landscape and 800px PC landscape */
    @media all and (min-width: 800px) and (orientation: landscape) {
      :host, #datepickerContainer {
        min-height: 320px;
        min-width: 480px;
        max-height: 360px;
        max-width: 640px;
      }

      #viewContainer, #selectionView, neon-animated-pages {
        max-width: 640px;
        /*max-height: calc(360px - 42px);*/
        max-height: calc(360px - 50px);
      }

      #selectionView, #selectionView div {
        max-width: calc(640px - 300px);
      }

      #dateContainer {
        /*max-height: calc(360px - 42px - 25px);*/
        max-height: calc(360px - 50px - 25px);
      }

      neon-animated-pages, #calendarView, #calendarView div, #yearView,
      #yearView #expandContainer {
        max-width: 300px;
      }

      #buttonContainer {
        max-width: 640px;
      }

      #dayContainer, #yearContainer, paper-icon-button, paper-button, .day:not([disabled]) {
        cursor: pointer;
      }

      .day.is-disabled {
        cursor: not-allowed;
      }
    }

    /* Used to solve position issue when yearContainer is selected */
    /*#yearContainer {
      top: 1px;
    }*/

    /* Used when it's desktop mode */
    /*#dayContainer, #yearContainer, paper-icon-button, paper-button, .day:not([disabled]) {
      cursor: pointer;
    }*/

  </style>

  <template>
    <iron-media-query query="(orientation: portrait)" query-matches="{{portrait}}"></iron-media-query>

    <!-- Datepicker Container-->
    <div id="datepickerContainer">

        <!-- View Container -->
        <div id="viewContainer" class$="{{_computeContainerCls(portrait)}}">
          <!-- Selection View-->
          <div id="selectionView">
            <!-- Weekday -->
            <div id="weekdayContainer">
              <span id="weekday">{{_selectedWeekday}}</span>
            </div>

            <!-- Date (Month, Day, Year)-->
            <div id="dateContainer">
              <!-- Month -->
              <div id="monthContainer">
                <span id="month">{{_selectedMonth}}</span>
              </div>

              <!-- Day -->
              <div id="dayContainer">
                <!-- to be removed -->
                <paper-ripple fit on-tap="_goCalView"></paper-ripple>
                <span id="day">{{_selectedDate}}</span>
              </div>

              <!-- Year -->
              <div id="yearContainer">
                <!-- to be removed -->
                <paper-ripple fit on-tap="_goYearView"></paper-ripple>
                <span id="year">{{_selectedYear}}</span>
              </div>
            </div>
          </div>

          <neon-animated-pages id="datepicker-pages" selected="{{_selectedView}}" attr-for-selected="data-view">
            <!-- Calendar View-->
            <div id="calendarView" data-view="calendar">
              <!-- monthYear -->
              <div id="monthYear">
                <paper-icon-button icon="chevron-left" on-tap="_prevMonth"></paper-icon-button>
                <span id="selectedMonthYear">
                  <span>{{_selectedMonthYear}}</span>
                </span>
                <paper-icon-button icon="chevron-right" on-tap="_nextMonth"></paper-icon-button>
              </div>

              <!-- weeks -->
              <div id="weekdays">
                <template is="dom-repeat" items="{{_weekdays}}">
                  <span>{{item}}</span>
                </template>
              </div>

              <!-- days -->
              <div id="days">
                <template is="dom-repeat" items="{{_days}}" as="day">
                  <div id$="[[_computeWeekId(index)]]" class="week-container">
                    <template is="dom-repeat" items="{{day}}">
                      <span class="day-container">
                        <div></div>
                        <div id$="[[_computeDayId(item)]]"
                             class$="{{_computeDayStyle(item, index, _disableCls)}}"
                             disabled$="{{_computeDisabledAttr(index)}}"
                             on-tap="_selectDate">{{item}}</div>
                        <div></div>
                      </span>
                    </template>
                  </div>
                </template>
              </div>
            </div>

            <!-- Year View -->
            <!-- year list -->
            <!-- <div id="yearView" data-view="year" on-scroll="_displayScroll" class="fit vertical layout">
              <iron-list id="yearList" items='[[years]]' class="flex"> -->
            <div id="yearView" data-view="year" on-scroll="_displayScroll">
              <div id="expandContainer">
                <div id="expandLessGroup">
                  <paper-icon-button icon="expand-less" on-tap="_prevCentury"></paper-icon-button>
                  <paper-icon-button icon="expand-less" on-tap="_prevDecade"></paper-icon-button>
                  <paper-icon-button icon="expand-less" on-tap="_prevYear"></paper-icon-button>
                </div>
                <div id="expandYear" class="relative">
                  <paper-ripple id="expandRipple" fit on-tap="_changeYear"></paper-ripple>
                  <span>{{_todayYear}}</span>
                </div>
                <div id="expandMoreGroup">
                  <paper-icon-button icon="expand-more" on-tap="_nextCentury"></paper-icon-button>
                  <paper-icon-button icon="expand-more" on-tap="_nextDecade"></paper-icon-button>
                  <paper-icon-button icon="expand-more" on-tap="_nextYear"></paper-icon-button>
                </div>
              </div>
            </div>
          </neon-animated-pages>
        </div>

      <!-- Button Container-->
      <div id="buttonContainer">
        <!-- <paper-button id="cancel">cancel</paper-button>
        <paper-button id="ok" on-tap="_formatDate">ok</paper-button> -->
        <paper-button dialog-dismiss>cancel</paper-button>
        <paper-button on-tap="_formatDate" dialog-confirm autofocus>ok</paper-button>
      </div>
    </div>
  </template>

</dom-module>

<script>

  var newDate = new Date();

  Polymer({

    is: 'jv-datepicker',

    hostAttributes: {
      'role': 'datepicker'
    },

    /*`Sunday` is the starting day of the week. arrayWeek = [`Sun`, `Mon`, `Tue`, `Wed`, `Thu`, `Fri`, `Sat`].*/
    properties: {
      startDay: {
        type: Number,
        value: 0
      },
      disableDays: {
        type: Array,
        value: function () {
          return [];
        }
      },
      _shiftedDisableDays: Array,
      _weekdays: {
        type: Array,
        value: function() {
          return [];
        }
      },
      _days: {
        type: Array,
        value: function() {
          return [];
        }
      },
      _selectedWeekday: {
        type: String,
        value: function() {
          return this._computeWeekday(newDate.getDay());
        }
      },
      _selectedDate: {
        type: Number,
        value: function() {
          return newDate.getDate();
        },
        observer: '_selectedDateChanged'
      },
      _selectedMonth: {
        type: String,
        value: function() {
          return this._computeMonth(newDate.getMonth(), true);
        }
      },
      _oldDate: Number,
      _todayDate: {
        type: Number,
        value: function() {
          return newDate.getDate();
        }
      },
      _todayMonth: {
        type: Number,
        value: function() {
          return newDate.getMonth();
        },
        observer: '_todayMonthChanged'
      },
      _selectedYear: {
        type: Number,
        value: function (){
          return newDate.getFullYear();
        }
      },
      _todayYear: {
        type: Number,
        value: function() {
          return newDate.getFullYear();
        }
      },
      _selectedMonthYear: String,
      _mthOffset: {
        type: Number,
        value: 0,
        observer: '_computeMonthYear'
      },
      _selectedView: {
        type: String,
        value: 'calendar'
      },
      _tempYear: Number,
      format: {
        type: String,
        value: function() {
          return 'yyyy-mm-dd';
        }
      },
      bindDate: {
        type: String,
        value: '2015-09-31',
        notify: true
      },
      _disableCls: {
        type: Boolean,
        value: false
      }
      // _years: {
      //   type: Array,
      //   value: function() {
      //     var i = 1581, res = [];
      //     while (i++ < 2100) {
      //       res.push(i);
      //     }
      //     return res;
      //   }
      // }
    },

    // Element Lifecycle

    ready: function () {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.

      // this._weekdays = this._computeWeekdays(this.startDay);
      // this._shiftDisabledDays(this.disableDays, this.startDay);
      // this._computeMonthYear(this._mthOffset);
    },

    attached: function () {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function () {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behaviorset

    /**
     * The `format-date` event is fired whenever `_formatDate` is called.
     *
     * @event format-date
     * @detail {{date: String}}
     */



    observers: [
      '_propChanged(startDay, disableDays, format)'
    ],

    _computeContainerCls: function (portrait) {
      var cls = 'layout vertical center-center';

      if (!portrait) {
        cls = 'layout horizontal center-center';
      }

      return cls;
      // if (potrait) {
      //   return 'layout vertical center-center';
      // } else {
      //   return 'layout horizontal center-center';
      // }
    },

    _computeWeekdays: function (startDay) {
      var arrayWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      // console.log(startDay);
      if (this._validateStartDay(startDay)) {
        for (var i = 0; i < startDay; i++) {
          arrayWeek.push(arrayWeek.shift());
        }
      }
      return arrayWeek;
    },

    _computeDays: function () {
      var arrayDays = [],
          arrayWeeks = [],
          pushElem,
          firstYear = this._todayYear,
          firstMonth = this._todayMonth,
          startDay = !this._validateStartDay(this.startDay)? 0: this.startDay%7, // startDay must be within 0 and 6, else normalize to 0.
          firstDayOfMonth = (new Date(firstYear, firstMonth, 1).getDay() + 7 - startDay)%7,
          totalDay = this._computeTotalDay(firstDayOfMonth, firstYear, firstMonth),
          totalRow = (totalDay + firstDayOfMonth)>35? 42: 35;

//          totalDay = firstDayOfMonth > 3? 42: 35; // 31 + firstDayOfMonth + (7 - (31 + firstDayOfMonth)%7);
        for (var i = 1, j = 0; i <= totalRow; i++, j++) {
          pushElem = i;

          if (firstDayOfMonth >= i) {
            pushElem = '';
          }else {
            pushElem = (pushElem - firstDayOfMonth) > totalDay? '': pushElem - firstDayOfMonth;
          }

          arrayWeeks.push(pushElem);
          if (j >= 6) {
            arrayDays.push(arrayWeeks);
            j = -1; // if set j to 0, totalDay needs to add 1;
            arrayWeeks = [];
          }
        }
//      return arrayDays;
      this._days = arrayDays;
    },

    _computeWeekId: function (idx) {
      return 'week' + idx;
    },

//    _computeWeekNumber: function () {
//      var now = new Date(),
//          onejan = new Date(now.getFullYear(), 0, 1);
//          weekNumber = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
//      return weekNumber;
//    },

    _selectedDateChanged: function (newValue, oldValue) {
      this._oldDate = oldValue;
      this._selectedDate = newValue;
      // remove oldValue's classList
      if (oldValue) {
        this._styleSelected.bind(this.$.days.querySelector('#day' + oldValue))();
      }
    },

    _selectDate: function (ev) {
      var target = ev.target;
      if (!target.hasAttribute('disabled') && ev.target.textContent) {
        // when select a date on the calendar, 4 things are needed to be changed:
        // a) Weekday b) Month c) Date d) Year
        this._selectedMonth = this._computeMonth(this._todayMonth, true);
        this._selectedDate = parseInt(ev.target.textContent);
        this._selectedYear = this._todayYear;
        this._selectedWeekday = this._computeWeekday(new Date(this._todayYear, this._todayMonth, this._selectedDate).getDay());
        this._styleSelected.bind(ev.target, true)();
      }
    },

    _styleSelected: function (addCls) {
      // console.log('style-selected');
      if (addCls) {
        // console.log('style-selected-add');
        this.classList.add('day-selected');
      }else {
        this.classList.remove('day-selected');
      }
    },

    _computeDayStyle: function (date, whichDay) {
      var cls = 'day',
          today = new Date(),
          tm = today.getMonth(),
          ty = today.getFullYear();

      // only today's date is selected...
      if (date === this._todayDate && this._todayMonth === tm && this._todayYear === ty) {
        cls = cls + ' is-today';
      }
      // only day is disabled...
      if (!date || this._isDisabledDay(whichDay)) {
        cls = cls + ' is-disabled';
      }

      return cls;
    },

    _computeDayId: function (idx) {
      return 'day' + idx;
    },

    _computeMonthYear: function () {
      var preTodayMth = this._todayMonth + this._mthOffset;
      this._todayMonth = (preTodayMth) < 0? 11: (preTodayMth)%12;

      this._mthOffset = 0;
      // render calendar once `todayMonth` changes...
      this._computeDays();
      this._selectedMonthYear = this._computeMonth(this._todayMonth) + ' ' + this._todayYear;
    },

    _computeMonth: function(monthIdx, to_slice) {
      var selectedMth = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][monthIdx];
      if (to_slice) {
        selectedMth = selectedMth.slice(0, 3);
      }
      return selectedMth;
    },

    _computeWeekday: function(weekdayIdx) {
      return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][weekdayIdx];
    },

    _prevMonth: function () {
      this._mthOffset--;
    },

    _nextMonth: function () {
      this._mthOffset++;
    },

    _todayMonthChanged: function (newValue, oldValue) {
      if (oldValue === 0 && newValue === 11){
        this._todayYear--;
      }else if(oldValue === 11 && newValue === 0){
        this._todayYear++;
      }
    },

    _computeTotalDay: function (firstDayOfMonth, firstYear, firstMonth) {
      var totalDay = 31;
      if (firstMonth === 1) {
        totalDay = new Date(firstYear, 1, 29).getMonth() === 1? 29: 28;
      }

      if (firstMonth === 3 || firstMonth === 5 || firstMonth === 8 || firstMonth === 10) {
          totalDay = 30;
      }
      return totalDay;
      // return (totalDay + firstDayOfMonth)>35? 42: 35;
    },

    _goYearView: function () {
      if (this._selectedView === 'year') {
        return;
      }else {
        // save initial value of _todayYear into _tempYear.
        // if no select any year, reset _todayYear to initial value from _tempYear.
        this._tempYear = this._todayYear;
        this._selectedView = 'year';
      }
    },

    _goCalView: function () {
      if (this._selectedView === 'calendar') {
        return;
      }else {
        // set _todayYear to its initial value from _tempYear.
        // if onFirstLoad is at 'calendar' page, _tempYear is undefined, hence
        // set _selectedYear instead.
        this._todayYear = this._tempYear || this._selectedYear;
        this._selectedView = 'calendar';
      }
    },

    _prevCentury: function () {
      this._todayYear = this._todayYear - 100;
    },

    _prevDecade: function () {
      this._todayYear = this._todayYear - 10;
    },

    _prevYear: function () {
      this._todayYear--;
    },

    _nextCentury: function () {
      this._todayYear = this._todayYear + 100;
    },

    _nextDecade: function () {
      this._todayYear = this._todayYear + 10;
    },

    _nextYear: function () {
      this._todayYear++;
    },

    _changeYear: function (ev) {
      this._selectedYear = this._todayYear;
      this._computeMonthYear();
      this._computeDays();
      this._selectedView = 'calendar';
    },

    _isDisabledDay: function (date) {
      if (this._shiftedDisableDays) {
        return this._shiftedDisableDays.some(function (el) {
          return date === el;
        });
      }
    },

    _validateDisableDays: function(disableDaysArr) {
      if (Array.isArray(disableDaysArr)) {
        return disableDaysArr.every(function(el){
          return el >= 0 && el < 7; // check if disableDays has value between 0 and 6;
        });
      }
    },

    _validateStartDay: function(startDay) {
      return startDay >= 0 && startDay < 7;
    },

    _computeDisabledAttr: function (whichDay) {
      return this._isDisabledDay(whichDay);
    },

    _shiftDisabledDays: function(disableDaysArr, startDay) {
      if (this._validateDisableDays(disableDaysArr) && this._validateStartDay(startDay)){
        var temp = [];
        disableDaysArr.forEach(function(el) {
          temp.push((el + 7 - startDay)%7);
        });
        this._shiftedDisableDays = temp;
      }else {
        this.setAttribute('disable-days', 'invalidArr');
      }
      // no return value as array mutation occurs inside function.
    },

    _formatDate: function() {
      var dateformat = this.format;
      var yearreg = dateformat.match(/y/gi),
          dayreg = dateformat.match(/d/gi),
          monthreg = dateformat.match(/m/gi);

      // regexp year
      if (yearreg) {
        var _formattedYear = this._selectedYear;
        switch (yearreg.length) {
          case 2:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]yy[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^yy[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]yy$/)) {
              dateformat = dateformat.replace(/y{1,2}/gi, _formattedYear%100);
              break;
            }
          default:
            dateformat = dateformat.replace(/[o]*[y]+[y|o]*/gi, _formattedYear);
        }
      }

      // regexp day
      if (dayreg) {
        var _formattedDay = this._selectedDate;
        switch (dayreg.length) {
          case 1:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]d[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^d[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]d$/)) {
              dateformat = dateformat.replace(/d/gi, _formattedDay);
              break;
            }

            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]do[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^do[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]do$/)) {
              var _suffixOrdinal, _cardinalNumber = _formattedDay%10;
              if (_formattedDay === 11 || _formattedDay === 12 || _formattedDay === 13) {
                _suffixOrdinal = 'th';
              }else {
                switch (_cardinalNumber) {
                  case 1:
                    _suffixOrdinal = 'st';
                    break;
                  case 2:
                    _suffixOrdinal = 'nd';
                    break;
                  case 3:
                    _suffixOrdinal = 'rd';
                    break;
                  default:
                    _suffixOrdinal = 'th';
                }
              }
              dateformat = dateformat.replace(/[o]*[d]+[o]+/gi, _formattedDay + _suffixOrdinal);
              break;
            }
          case 2:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]dd[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^dd[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]dd$/)) {
                dateformat = dateformat.replace(/[d]+/gi, _formattedDay.toString().replace(/^(\d)$/gi, '0$1'));
              break;
            }
          default:
            dateformat = dateformat.replace(/[o]*[d]+[d|0]*/gi, _formattedDay.toString().replace(/^(\d)$/gi, '0$1'));
        }
      }

      // regexp month
      if (monthreg) {
        var _numberedMonth = this._todayMonth, _formattedMonth;
        switch (monthreg.length) {
          case 1:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]m[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^m[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]m$/)) {
              dateformat = dateformat.replace(/m/gi, _numberedMonth + 1);
              break;
            }
          case 2:
          case 3:
          case 4:
            if (dateformat.match(/[$-/:-?{-~!"^_`\[\]]m{2,4}[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/^m{2,4}[$-/:-?{-~!"^_`\[\]]/) ||
                dateformat.match(/[$-/:-?{-~!"^_`\[\]]m{2,4}$/)) {
              _formattedMonth = _numberedMonth + 1;
              if (monthreg.length === 2) {
                dateformat = dateformat.replace(/[m]+/gi, _formattedMonth.toString().replace(/^(\d)$/gi, '0$1'));
              }else if (monthreg.length === 3) {
                dateformat = dateformat.replace(/[m]+/gi, this._selectedMonth);
              }else {
                dateformat = dateformat.replace(/[m]+/gi, this._computeMonth(_numberedMonth));
              }
              break;
            }
          default:
            dateformat = dateformat.replace(/[o]*[m]+[o]*/gi, _numberedMonth + 1);
        }
      }
      // parse formatted date
      this.bindDate = dateformat;

      //fireDate
      this.fire('format-date', {date: dateformat});

      console.log(this.bindDate);
      // console.log(dateformat);
      // console.log(this._selectedYear);
      // console.log(this._selectedMonth);
      // console.log(this._selectedDate);
    },

    _propChanged: function(startDay, disableDays, format) {
      this._weekdays = this._computeWeekdays(startDay);
      this._shiftDisabledDays(disableDays, startDay);
      this._computeDays();
      this._disableCls = !this._disableCls; // workaround to force _computeDayStyle to execute on the dom;
    }
  });
</script>
